//================================================================================================//
//                                                                                                //
// PROJET       : DongleWifi GoodRace                                                             //
// MODULE       : Board                                                                           //
// DESCRIPTION  :                                                                                 //
// CREATION     : 27/01/2020                                                                      //
// HISTORIQUE   :                                                                                 //
//                                                                                                //
//================================================================================================//

//================================================================================================//
//                                        FICHIERS INCLUS                                         //
//================================================================================================//
#include "./screen.h"

//================================================================================================//
//                                            DEFINES                                             //
//================================================================================================//

//================================================================================================//
//                                          ENUMERATIONS                                          //
//================================================================================================//

//================================================================================================//
//                                      STRUCTURES ET UNIONS                                      //
//================================================================================================//

////////////////////////////////////////////////////////////////////////////////////////////////////
//                                 VARIABLES PRIVEES ET PARTAGEES                                 //
////////////////////////////////////////////////////////////////////////////////////////////////////

//------------------------------------------------------------------------------------------------//
//---                                         Privees                                          ---//
//------------------------------------------------------------------------------------------------//
static e_SCREEN _e_screen = SCREEN_BOOTING;
static e_SCREEN _old_e_screen = SCREEN_MAX;
static unsigned long _ms = millis();
static float updateProgress = 0.00;
//------------------------------------------------------------------------------------------------//
//---                                        Partagees                                         ---//
//------------------------------------------------------------------------------------------------//

////////////////////////////////////////////////////////////////////////////////////////////////////
//                                 FONCTIONS PRIVEES ET PARTAGEES                                 //
////////////////////////////////////////////////////////////////////////////////////////////////////

//------------------------------------------------------------------------------------------------//
//---                                         Privees                                          ---//
//------------------------------------------------------------------------------------------------//

//------------------------------------------------------------------------------------------------//
//---                                        Partagees                                         ---//
//------------------------------------------------------------------------------------------------//

//-----------------------------------------------------------------------------
// FONCTION    :  SCREEN_Init
//
// DESCRIPTION :  Initialisation de l'ecran
//-----------------------------------------------------------------------------
void SCREEN_Init(void)
{
   DISPLAY_Init();
   _e_screen = SCREEN_BOOTING;
   _ms = millis();
}

//--------------------------------------------------------------------------------------------------
// FONCTION    : SCREEN_TaskInit
//
// DESCRIPTION : Initialisation de la tache
//--------------------------------------------------------------------------------------------------
bool SCREEN_TaskInit(void)
{
   SCREEN_Init();
   _e_screen = SCREEN_BOOTING;
   _old_e_screen = SCREEN_MAX;
   return true;
}

void SCREEN_Change(e_SCREEN _s)
{
   _e_screen = _s;
}

//-----------------------------------------------------------------------------
// FONCTION    : SCREEN_TaskUpdate
//
// DESCRIPTION : MAJ de la Tache : gestion evenements
//-----------------------------------------------------------------------------
bool SCREEN_TaskUpdate(void *p)
{
   return true;
}

void SCREEN_SetUpdateProgress(float value)
{
   updateProgress = value;
}

void SCREEN_TaskRun(void)
{
   bool forceRefresh = _e_screen == SCREEN_HOME ? true : false;
   if ((_e_screen == SCREEN_BOOTING) && (millis() - _ms) >= 5000)
   {
      SCREEN_Change(SCREEN_HOME);
   }
   if (_e_screen != _old_e_screen)
   {
      DISPLAY_FillScreen();
      forceRefresh = true;
      _old_e_screen = _e_screen;
   }

   if (forceRefresh == true)
   {
      switch (_e_screen)
      {
      case (SCREEN_BOOTING):
      {
         DISPLAY_Booting();
         break;
      }
      case (SCREEN_HOME):
      {
         DISPLAY_Voltage();
         DISPLAY_WifiDetails();
         break;
      }
      case (SCREEN_UPDATE):
      {
         DISPLAY_Booting();
         DISPLAY_Progress(updateProgress);
         break;
      }
      default:
      {
         break;
      }
      }
   }
}